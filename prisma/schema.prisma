generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Auth & Security ---

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  username         String?   @unique
  password         String?
  name             String?
  avatar           String?
  role             String    @default("user") // 'user', 'admin', 'super_admin'
  profileCompleted Boolean   @default(false)
  orcidId          String?   @unique
  emailVerified    Boolean   @default(false)
  emailVerifiedAt  DateTime?
  twoFactorEnabled Boolean   @default(false)
  accountLocked    Boolean   @default(false)
  tokenVersion     Int       @default(1)

  deletedAt          DateTime?
  deleteScheduledFor DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Profile & Metadata (GitHub Parity)
  bio      String? @db.Text
  company  String?
  location String?
  website  String?
  twitter  String?
  linkedin String?
  github   String?

  // Profile README & Resume
  profileReadme    String?   @db.Text
  resumeUrl        String?
  resumeFilename   String?
  resumeUploadedAt DateTime?
  showResume       Boolean   @default(false)
  showReadme       Boolean   @default(true)

  // Portfolio & Repository Display
  showPortfolio     Boolean  @default(true)
  showRepositories  Boolean  @default(true)
  showContributions Boolean  @default(true)
  pinnedItems       String[]

  // Relations
  oauthAccounts     OAuthAccount[]
  sessions          Session[]
  loginAttempts     LoginAttempt[]
  workspaces        Workspace[] // Owned workspaces
  jobsCreated       Job[]              @relation("JobCreator")
  orgMemberships    OrgMember[]
  wallet            Wallet?
  freelancerProfile FreelancerProfile?
  activityLogs      ActivityLog[]
  enterpriseMembers EnterpriseMember[]
  teamMembers       TeamMember[]
  jobApplications   JobApplication[]

  customProfile       Profile?
  sshKeys             SSHKey[]
  gpgKeys             GPGKey[]
  repositories        Repository[]         @relation("RepoOwner")
  following           Follow[]             @relation("Following")
  followers           Follow[]             @relation("Followers")
  auditLogs           AuditLog[]
  mergedPRs           PullRequest[]        @relation("PRMerger")
  prreviews           PRReview[]
  issues              Issue[]              @relation("IssueAuthor")
  pullRequests        PullRequest[]        @relation("PRAuthor")
  closedIssues        Issue[]              @relation("IssueCloser")
  issueAssignees      IssueAssignee[]
  discussions         Discussion[]         @relation("DiscussionAuthor")
  discussionComments  DiscussionComment[]  @relation("DiscussionCommentAuthor")
  discussionReactions DiscussionReaction[] @relation("DiscussionReactions")
  comments            Comment[]

  // Messaging
  conversationParticipants ConversationParticipant[]
  sentMessages             Message[]                 @relation("MessageSender")
  Issue                    Issue[]

  // Portfolio
  portfolioItems PortfolioItem[]

  // Community
  communityPosts       CommunityPost[]
  communityComments    CommunityComment[]
  postLikes            CommunityPostLike[]
  communitiesCreated   Community[]         @relation("CommunityCreator")
  communityMemberships CommunityMember[]
  notifications        Notification[]

  // Skill Radar
  skillScore    UserSkillScore?
  skillMetrics  SkillRawMetrics?
}

model Profile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  bio            String? @db.Text
  location       String?
  website        String?
  company        String?
  followersCount Int     @default(0)
  followingCount Int     @default(0)

  socialLinks SocialLink[]
}

model SocialLink {
  id        String  @id @default(uuid())
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id])
  platform  String // 'github', 'twitter', 'linkedin', etc.
  url       String
}

model SSHKey {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  title     String
  key       String   @db.Text
  createdAt DateTime @default(now())
}

model GPGKey {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  keyId     String   @unique
  publicKey String   @db.Text
  createdAt DateTime @default(now())
}

model Follow {
  followerId  String
  follower    User     @relation("Following", fields: [followerId], references: [id])
  followingId String
  following   User     @relation("Followers", fields: [followingId], references: [id])
  createdAt   DateTime @default(now())

  @@id([followerId, followingId])
}

model OAuthAccount {
  id                String  @id @default(uuid())
  provider          String
  providerAccountId String
  accessToken       String? @db.Text
  refreshToken      String? @db.Text
  tokenType         String?
  idToken           String? @db.Text
  scope             String?
  userId            String
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model OAuthProvider {
  id          String   @id @default(uuid())
  name        String   @unique // e.g., 'google', 'github'
  displayName String
  enabled     Boolean  @default(true)
  icon        String? // URL or icon name
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Session {
  id             String    @id @default(uuid())
  sessionId      String    @unique
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String?
  workspaceId    String?
  ipAddress      String?
  userAgent      String?
  csrfToken      String?
  tokenVersion   Int       @default(1)
  expiresAt      DateTime
  revokedAt      DateTime?
  lastActivityAt DateTime  @default(now())
  createdAt      DateTime  @default(now())
}

model LoginAttempt {
  id            String   @id @default(uuid())
  email         String
  ipAddress     String?
  userAgent     String?
  success       Boolean
  failureReason String?
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  createdAt     DateTime @default(now())
}

model VerificationToken {
  id         String   @id @default(uuid())
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())

  @@unique([identifier, token])
}

model Permission {
  id        String    @id @default(uuid())
  role      String
  resource  String
  action    String
  userId    String
  expiresAt DateTime?
}

model FeatureFlag {
  id          String   @id @default(uuid())
  name        String   @unique
  enabled     Boolean  @default(true)
  description String?
  updatedAt   DateTime @updatedAt
}

// --- Core Application ---

model Organization {
  id        String       @id @default(uuid())
  name      String
  createdAt DateTime     @default(now())
  members   OrgMember[]
  jobs      Job[]
  repos     Repository[]

  enterpriseId     String?
  enterprise       Enterprise?       @relation(fields: [enterpriseId], references: [id])
  teams            Team[]
  auditLogs        AuditLog[]
  encryptedSecrets EncryptedSecret[]
}

model OrgMember {
  id       String       @id @default(uuid())
  orgId    String
  org      Organization @relation(fields: [orgId], references: [id])
  userId   String
  user     User         @relation(fields: [userId], references: [id])
  role     String       @default("MEMBER") // OWNER, ADMIN, MEMBER
  joinedAt DateTime     @default(now())

  @@unique([orgId, userId])
}

model Repository {
  id          String   @id @default(uuid())
  name        String
  description String?
  isPublic    Boolean  @default(false)
  language    String?
  stars       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  settings    Json?    @default("{}")

  ownerId String
  owner   User   @relation("RepoOwner", fields: [ownerId], references: [id])

  // Visibility (Integravity Expansion)
  visibility String  @default("PUBLIC") // PUBLIC, PRIVATE, INTERNAL
  isTemplate Boolean @default(false)

  deletedAt    DateTime?
  dependencies Json? // Parsed dependency graph data

  // Relations
  branchProtections BranchProtection[]
  statusChecks      StatusCheck[]

  // Organizations & Context
  orgId        String?
  org          Organization? @relation(fields: [orgId], references: [id])
  enterpriseId String? // Denormalized for RLS

  // Forking Logic
  forkedFromId String?
  parent       Repository?  @relation("RepoForks", fields: [forkedFromId], references: [id])
  forks        Repository[] @relation("RepoForks")
  forksCount   Int          @default(0)

  // UI & Metadata
  aiHealth        Int       @default(100)
  aiHealthLabel   String    @default("Optimal")
  techStack       String?
  techColor       String?
  license         Json? // Stores license object { key, name, spdx_id, url, node_id }
  openIssuesCount Int       @default(0)
  lastSyncAt      DateTime?

  securityAlerts  SecurityAlert[]
  aiTasks         AITask[]
  jobs            Job[]
  teamPermissions RepoPermission[]

  // Collaboration (Integravity Phase 4)
  issues           Issue[]
  pullRequests     PullRequest[]
  labels           Label[]
  milestones       Milestone[]
  projectBoards    ProjectBoard[]
  discussions      Discussion[]
  // CI/CD (Integravity Phase 5)
  workflowRuns     WorkflowRun[]
  activityLogs     ActivityLog[]
  auditLogs        AuditLog[]
  workflows        Workflow[]
  encryptedSecrets EncryptedSecret[]
}

model Issue {
  id     String  @id @default(uuid())
  number Int // Repo-relative incrementing number
  title  String
  body   String? @db.Text
  status String  @default("OPEN") // OPEN, CLOSED

  authorId String
  author   User   @relation("IssueAuthor", fields: [authorId], references: [id])

  repoId String
  repo   Repository @relation(fields: [repoId], references: [id])

  milestoneId String?
  milestone   Milestone? @relation(fields: [milestoneId], references: [id])

  labels    Label[]
  comments  Comment[]
  assignees IssueAssignee[]

  // Close tracking
  closedAt     DateTime?
  closedBy     String?
  closedByUser User?     @relation("IssueCloser", fields: [closedBy], references: [id])
  stateReason  String? // completed, not_planned, reopened

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  boardCards BoardCard[]
  user       User?       @relation(fields: [userId], references: [id])
  userId     String?

  @@unique([repoId, number])
}

model IssueAssignee {
  id        String   @id @default(uuid())
  issueId   String
  issue     Issue    @relation(fields: [issueId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@unique([issueId, userId])
}

model ProjectBoard {
  id          String        @id @default(uuid())
  repoId      String
  repo        Repository    @relation(fields: [repoId], references: [id])
  name        String
  description String?       @db.Text
  layout      String        @default("KANBAN") // KANBAN, TABLE
  columns     BoardColumn[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model BoardColumn {
  id        String       @id @default(uuid())
  boardId   String
  board     ProjectBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)
  name      String
  position  Int
  cards     BoardCard[]
  createdAt DateTime     @default(now())
}

model BoardCard {
  id        String       @id @default(uuid())
  columnId  String
  column    BoardColumn  @relation(fields: [columnId], references: [id], onDelete: Cascade)
  issueId   String?
  issue     Issue?       @relation(fields: [issueId], references: [id])
  prId      String?
  pr        PullRequest? @relation(fields: [prId], references: [id])
  noteTitle String?
  noteBody  String?      @db.Text
  position  Int
  createdAt DateTime     @default(now())
}

model PullRequest {
  id     String  @id @default(uuid())
  number Int // Repo-relative
  title  String
  body   String? @db.Text
  status String  @default("OPEN") // OPEN, CLOSED, MERGED
  draft  Boolean @default(false)

  base String // e.g. "main"
  head String // e.g. "feature/xyz"

  authorId String
  author   User   @relation("PRAuthor", fields: [authorId], references: [id])

  repoId String
  repo   Repository @relation(fields: [repoId], references: [id])

  labels   Label[]
  comments Comment[]
  reviews  PRReview[]

  // Merge tracking
  mergedAt     DateTime?
  mergedBy     String?
  mergedByUser User?     @relation("PRMerger", fields: [mergedBy], references: [id])
  closedAt     DateTime?
  diffStats    Json? // { additions, deletions, changedFiles }

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  boardCards BoardCard[]

  @@unique([repoId, number])
}

model PRReview {
  id            String      @id @default(uuid())
  pullRequestId String
  pullRequest   PullRequest @relation(fields: [pullRequestId], references: [id])
  reviewerId    String
  reviewer      User        @relation(fields: [reviewerId], references: [id])
  status        String // APPROVED, CHANGES_REQUESTED, COMMENTED
  body          String?     @db.Text
  createdAt     DateTime    @default(now())
}

model Comment {
  id   String @id @default(uuid())
  body String @db.Text

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  issueId String?
  issue   Issue?  @relation(fields: [issueId], references: [id])

  pullRequestId String?
  pullRequest   PullRequest? @relation(fields: [pullRequestId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Label {
  id          String  @id @default(uuid())
  name        String
  color       String  @default("#cccccc")
  description String?

  repoId String
  repo   Repository @relation(fields: [repoId], references: [id])

  issues       Issue[]
  pullRequests PullRequest[]

  @@unique([repoId, name])
}

model Milestone {
  id          String    @id @default(uuid())
  title       String
  description String?
  state       String    @default("OPEN") // OPEN, CLOSED
  dueDate     DateTime?

  repoId String
  repo   Repository @relation(fields: [repoId], references: [id])

  issues Issue[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([repoId, title])
}

model Discussion {
  id        String               @id @default(uuid())
  repoId    String
  repo      Repository           @relation(fields: [repoId], references: [id])
  number    Int
  title     String
  body      String?              @db.Text
  category  String               @default("GENERAL") // Q&A, IDEAS, GENERAL, ANNOUNCEMENTS
  authorId  String
  author    User                 @relation("DiscussionAuthor", fields: [authorId], references: [id])
  locked    Boolean              @default(false)
  answerId  String?              @unique
  answer    DiscussionComment?   @relation("MarkedAnswer", fields: [answerId], references: [id])
  comments  DiscussionComment[]  @relation("DiscussionComments")
  reactions DiscussionReaction[]
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  @@unique([repoId, number])
}

model DiscussionComment {
  id                String               @id @default(uuid())
  discussionId      String
  discussion        Discussion           @relation("DiscussionComments", fields: [discussionId], references: [id], onDelete: Cascade)
  parentId          String?
  parent            DiscussionComment?   @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies           DiscussionComment[]  @relation("CommentReplies")
  authorId          String
  author            User                 @relation("DiscussionCommentAuthor", fields: [authorId], references: [id])
  body              String               @db.Text
  reactions         DiscussionReaction[]
  markedAsAnswerFor Discussion?          @relation("MarkedAnswer")
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
}

model DiscussionReaction {
  id           String             @id @default(uuid())
  userId       String
  user         User               @relation("DiscussionReactions", fields: [userId], references: [id])
  discussionId String?
  discussion   Discussion?        @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  commentId    String?
  comment      DiscussionComment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  emoji        String // üëç, ‚ù§Ô∏è, üéâ, üòÑ, üòï, üöÄ, üëÄ
  createdAt    DateTime           @default(now())

  @@unique([userId, discussionId, emoji])
  @@unique([userId, commentId, emoji])
}

model BranchProtection {
  id      String     @id @default(uuid())
  repoId  String
  repo    Repository @relation(fields: [repoId], references: [id])
  pattern String // e.g. "main", "release/*"

  requiredReviews      Int     @default(0)
  requireSignedCommits Boolean @default(false)
  requireStatusChecks  Boolean @default(false)
  dismissStaleReviews  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([repoId, pattern])
}

model StatusCheck {
  id     String     @id @default(uuid())
  repoId String
  repo   Repository @relation(fields: [repoId], references: [id])

  context     String // e.g. "ci/circleci", "lint"
  state       String // PENDING, SUCCESS, FAILURE, ERROR
  targetUrl   String?
  description String?

  commitSha String // The SHA this check applies to

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([repoId, commitSha, context])
}

model SecurityAlert {
  id     String     @id @default(uuid())
  repoId String
  repo   Repository @relation(fields: [repoId], references: [id])

  type        String  @default("VULNERABILITY") // SECRET, SCA, SAST
  severity    String // LOW, MEDIUM, HIGH, CRITICAL
  description String
  resource    String? // file path or package.json
  status      String  @default("OPEN") // OPEN, FIXED, DISMISSED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AITask {
  id        String     @id @default(uuid())
  repoId    String
  repo      Repository @relation(fields: [repoId], references: [id])
  taskName  String
  prompt    String     @db.Text
  context   Json? // File context, diffs, etc.
  model     String
  status    String // PENDING, PROCESSING, COMPLETED, FAILED
  result    String? // JSON string or text result
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model Workspace {
  id          String  @id @default(uuid())
  name        String
  description String?
  status      String  @default("Active")
  ownerId     String
  owner       User    @relation(fields: [ownerId], references: [id])

  // Repo Integration
  repoUrl        String?
  visibility     String  @default("public") // public, private
  accessPassword String?

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  activityLogs   ActivityLog[]
  communityPosts CommunityPost[]
}

// --- Jobs & Marketplace ---

model Job {
  id          String   @id @default(uuid())
  title       String
  description String
  budget      String?
  type        String // Fixed, Hourly
  techStack   String[] // Array of strings in Postgres
  status      String   @default("Open") // Open, InProgress, Completed

  creatorId String
  creator   User   @relation("JobCreator", fields: [creatorId], references: [id])

  orgId String?
  org   Organization? @relation(fields: [orgId], references: [id])

  repositoryId String?
  repository   Repository? @relation(fields: [repositoryId], references: [id])

  applications JobApplication[]
  contract     EscrowContract?
  reviews      JobReview[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model JobApplication {
  id          String @id @default(uuid())
  jobId       String
  job         Job    @relation(fields: [jobId], references: [id])
  applicantId String
  applicant   User   @relation(fields: [applicantId], references: [id])

  status String @default("Pending") // Screening, Shortlisted, Hired, Rejected
  stage  String @default("Applied") // Applied, Phone Screen, Interview, Offer, Hired, Rejected

  coverLetter String? @db.Text
  resumeUrl   String?
  score       Float   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([jobId, applicantId])
}

model JobReview {
  id    String @id @default(uuid())
  jobId String
  job   Job    @relation(fields: [jobId], references: [id])

  freelancerId String
  freelancer   FreelancerProfile @relation(fields: [freelancerId], references: [id])

  reviewerId String // User ID of employer

  rating    Float
  comment   String?
  createdAt DateTime @default(now())
}

model FreelancerProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  jobsCompleted Int         @default(0)
  rating        Float       @default(0.0)
  isPublic      Boolean     @default(true)
  reviews       JobReview[]
}

// --- Finance ---

model Wallet {
  id           String        @id @default(uuid())
  userId       String        @unique
  user         User          @relation(fields: [userId], references: [id])
  balance      Float         @default(0.0)
  transactions Transaction[]
  updatedAt    DateTime      @updatedAt
}

model Transaction {
  id          String   @id @default(uuid())
  walletId    String
  wallet      Wallet   @relation(fields: [walletId], references: [id])
  amount      Float
  type        String // DEPOSIT, WITHDRAW, ESCROW_HOLD, RELEASE
  description String?
  referenceId String? // ID of job or external ref
  createdAt   DateTime @default(now())
}

model EscrowContract {
  id           String   @id @default(uuid())
  jobId        String   @unique
  job          Job      @relation(fields: [jobId], references: [id])
  amountLocked Float
  status       String // HELD, RELEASED, DISPUTED, REFUNDED
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ActivityLog {
  id      String  @id @default(uuid())
  userId  String?
  action  String
  details Json?

  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id])

  repoId String?
  repo   Repository? @relation(fields: [repoId], references: [id])

  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
}

// --- ENTERPRISE FEATURES ---

model Enterprise {
  id     String  @id @default(uuid())
  slug   String  @unique
  name   String
  domain String? // Auto-join users from this domain
  plan   String  @default("ENTERPRISE") // FREE, BUSINESS, ENTERPRISE
  status String  @default("ACTIVE") // ACTIVE, SUSPENDED

  // Settings
  ssoRequired       Boolean  @default(false)
  twoFactorRequired Boolean  @default(false)
  ipAllowlist       String[] // Array of CIDRs
  region            String   @default("us-east-1") // Data residency control

  // Relations
  members       EnterpriseMember[]
  organizations Organization[] // "Workspaces"
  policies      Policy[]
  auditLogs     AuditLog[]
  ssoConfig     SSOConfig?
  subscription  Subscription?
  usage         EnterpriseUsage[]
  runnerGroups  RunnerGroup[]
  devices       TrustedDevice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EnterpriseMember {
  id           String     @id @default(uuid())
  enterpriseId String
  enterprise   Enterprise @relation(fields: [enterpriseId], references: [id])
  userId       String
  user         User       @relation(fields: [userId], references: [id])

  role     String   @default("MEMBER") // OWNER, ADMIN, SECURITY_ADMIN, BILLING_ADMIN
  joinedAt DateTime @default(now())

  @@unique([enterpriseId, userId])
}

// --- Community Features ---

model CommunityPost {
  id      String  @id @default(uuid())
  title   String?
  content String  @db.Text
  type    String  @default("discussion") // discussion, question, showcase, job_alert, repo_update

  // Metadata for rich posts
  mediaUrl    String?
  codeSnippet Json? // { language, code }
  repoLink    Json? // { name, description, stars, language }
  jobDetails  Json? // { company, role, salary, location }

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  likes Int @default(0)
  views Int @default(0)

  comments CommunityComment[]
  likedBy  CommunityPostLike[]

  // New Relations
  communityId String?
  community   Community? @relation(fields: [communityId], references: [id])

  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id])

  researchPaperUrl String? // For academic/research posts

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Community {
  id           String  @id @default(uuid())
  slug         String  @unique
  name         String
  description  String? @db.Text
  avatar       String?
  coverImage   String?
  isSearchable Boolean @default(true)

  creatorId String
  creator   User   @relation("CommunityCreator", fields: [creatorId], references: [id])

  members CommunityMember[]
  posts   CommunityPost[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CommunityMember {
  id          String    @id @default(uuid())
  communityId String
  community   Community @relation(fields: [communityId], references: [id])
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  role        String    @default("MEMBER") // MEMBER, MODERATOR, ADMIN
  joinedAt    DateTime  @default(now())

  @@unique([communityId, userId])
}

model CommunityComment {
  id   String @id @default(uuid())
  text String @db.Text

  postId String
  post   CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CommunityPostLike {
  id        String        @id @default(uuid())
  postId    String
  post      CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime      @default(now())

  @@unique([postId, userId])
}

model SSOConfig {
  id           String     @id @default(uuid())
  enterpriseId String     @unique
  enterprise   Enterprise @relation(fields: [enterpriseId], references: [id])

  provider    String // SAML, OIDC
  entryPoint  String // IdP Login URL
  issuer      String // IdP Entity ID
  cert        String? // Public Key (PEM)
  scimEnabled Boolean @default(false)
  scimToken   String? // Secret token for SCIM

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- Messaging System ---

model Conversation {
  id   String  @id @default(uuid())
  type String  @default("DIRECT") // DIRECT, GROUP
  name String? // For group chats

  participants ConversationParticipant[]
  messages     Message[]

  lastMessageAt DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ConversationParticipant {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  joinedAt   DateTime  @default(now())
  lastReadAt DateTime?

  @@unique([conversationId, userId])
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId String
  sender   User   @relation("MessageSender", fields: [senderId], references: [id])

  content String @db.Text
  type    String @default("TEXT") // TEXT, IMAGE, CODE, SYSTEM

  readBy Json? // Array of userIds who read the message

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Policy {
  id           String     @id @default(uuid())
  enterpriseId String
  enterprise   Enterprise @relation(fields: [enterpriseId], references: [id])

  // Types: REPO_VISIBILITY, LICENSE_CHECK, SECRET_SCANNING, 
  //        OFFLINE_MODE, DEVICE_TRUST, RUNNER_CONSTRAINT, CLIPBOARD_SCANNING
  type     String
  name     String
  config   Json // e.g. { "allowed_licenses": ["MIT"], "block_offline_exec": true }
  enforced Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AuditLog {
  id String @id @default(uuid())

  enterpriseId String?
  enterprise   Enterprise? @relation(fields: [enterpriseId], references: [id])

  orgId        String?
  organization Organization? @relation(fields: [orgId], references: [id])

  repoId String?
  repo   Repository? @relation(fields: [repoId], references: [id])

  actorId String
  actor   User   @relation(fields: [actorId], references: [id])

  action    String // AUTH_LOGIN, REPO_DELETE, POLICY_CHANGE, EXECUTION_START
  resource  String
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
}

// --- Execution & Runners ---

model RunnerGroup {
  id           String     @id @default(uuid())
  enterpriseId String
  enterprise   Enterprise @relation(fields: [enterpriseId], references: [id])

  name         String
  allowsPublic Boolean  @default(false)
  runners      Runner[]

  createdAt DateTime @default(now())
}

model Runner {
  id            String      @id @default(uuid())
  runnerGroupId String
  group         RunnerGroup @relation(fields: [runnerGroupId], references: [id])

  name       String
  status     String // ONLINE, OFFLINE, BUSY
  os         String
  arch       String // x64, arm64
  labels     String[] // ["gpu", "high-mem"]
  version    String
  lastSeenAt DateTime @default(now())
  createdAt  DateTime @default(now())

  jobs WorkflowJob[]
}

model WorkflowRun {
  id     String     @id @default(uuid())
  repoId String
  repo   Repository @relation(fields: [repoId], references: [id])

  workflowId String?
  workflow   Workflow? @relation(fields: [workflowId], references: [id])

  workflowName String // e.g. "CI", "Deploy"
  commitSha    String
  event        String // push, pull_request, workflow_dispatch
  status       String  @default("QUEUED") // QUEUED, IN_PROGRESS, COMPLETED, CANCELLED
  conclusion   String? // SUCCESS, FAILURE, NEUTRAL, CANCELLED, TIMED_OUT, ACTION_REQUIRED

  jobs WorkflowJob[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  artifacts Artifact[]
}

model WorkflowJob {
  id            String      @id @default(uuid())
  workflowRunId String
  workflowRun   WorkflowRun @relation(fields: [workflowRunId], references: [id])

  name        String
  status      String    @default("QUEUED")
  conclusion  String?
  startedAt   DateTime?
  completedAt DateTime?

  runnerId String?
  runner   Runner? @relation(fields: [runnerId], references: [id])

  needs      String[] // Array of Job Names this job depends on
  definition Json? // Snapshot of the job definition (env, steps, etc)
  matrix     Json? // Matrix context for this job (e.g. { node: 18, os: linux })
  steps      Json? // Detailed steps execution state
  logs       String?  @db.Text

  // Drone/Engine Mapping
  externalId String? // ID in Drone/Engine

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Integravity Native CI Models

model Workflow {
  id     String     @id @default(uuid())
  repoId String
  repo   Repository @relation(fields: [repoId], references: [id])
  name   String // 'Build and Test'
  path   String // '.trackcodex/workflows/ci.yml'
  state  String     @default("ACTIVE") // ACTIVE, DISABLED

  versions WorkflowVersion[]
  runs     WorkflowRun[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([repoId, path])
}

model WorkflowVersion {
  id          String   @id @default(uuid())
  workflowId  String
  workflow    Workflow @relation(fields: [workflowId], references: [id])
  version     Int // Incremental
  yamlContent String   @db.Text
  commitSha   String

  createdAt DateTime @default(now())
}

model EncryptedSecret {
  id    String @id @default(uuid())
  name  String
  value String @db.Text // Encrypted value

  // Scope
  repoId String?
  repo   Repository?   @relation(fields: [repoId], references: [id])
  orgId  String?
  org    Organization? @relation(fields: [orgId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([repoId, name])
  @@unique([orgId, name])
}

model Artifact {
  id            String      @id @default(uuid())
  workflowRunId String
  workflowRun   WorkflowRun @relation(fields: [workflowRunId], references: [id])

  name      String
  path      String // S3 Key
  sizeBytes Int
  expiresAt DateTime?

  createdAt DateTime @default(now())
}

// --- Billing & Usage ---

model Subscription {
  id           String     @id @default(uuid())
  enterpriseId String     @unique
  enterprise   Enterprise @relation(fields: [enterpriseId], references: [id])

  planId       String
  seats        Int
  status       String // ACTIVE, PAST_DUE, CANCELED
  billingEmail String?

  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  invoices  Invoice[]
  updatedAt DateTime  @updatedAt
}

model EnterpriseUsage {
  id           String     @id @default(uuid())
  enterpriseId String
  enterprise   Enterprise @relation(fields: [enterpriseId], references: [id])

  month          String // "2023-10"
  seatsUsed      Int    @default(0)
  computeMinutes Int    @default(0)
  storageBytes   BigInt @default(0)
  aiTokens       Int    @default(0)

  updatedAt DateTime @updatedAt

  @@unique([enterpriseId, month])
}

model Invoice {
  id             String       @id @default(uuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])

  amount   Float
  currency String   @default("USD")
  status   String // PAID, OPEN, VOID
  url      String? // PDF link
  issuedAt DateTime @default(now())
}

// --- Desktop Security ---

model TrustedDevice {
  id           String     @id @default(uuid())
  enterpriseId String
  enterprise   Enterprise @relation(fields: [enterpriseId], references: [id])

  hostname    String
  os          String
  fingerprint String // Hardware hash
  status      String // PENDING, APPROVED, REVOKED
  lastSeenAt  DateTime @default(now())
  createdAt   DateTime @default(now())
}

// --- Teams ---

model Team {
  id             String       @id @default(uuid())
  name           String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  description String?
  members     TeamMember[]
  permissions RepoPermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TeamMember {
  id     String @id @default(uuid())
  teamId String
  team   Team   @relation(fields: [teamId], references: [id])
  userId String
  user   User   @relation(fields: [userId], references: [id])
  role   String @default("MEMBER") // MAINTAINER, MEMBER

  @@unique([teamId, userId])
}

model RepoPermission {
  id     String     @id @default(uuid())
  teamId String
  team   Team       @relation(fields: [teamId], references: [id])
  repoId String
  repo   Repository @relation(fields: [repoId], references: [id])
  level  String // READ, WRITE, ADMIN

  @@unique([teamId, repoId])
}

model PortfolioItem {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title        String
  description  String   @db.Text
  imageUrl     String?
  demoUrl      String?
  sourceUrl    String?
  technologies String[]

  featured Boolean @default(false)
  order    Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, featured])
  @@index([userId, order])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  link      String?
  metadata  Json?
  createdAt DateTime @default(now())
}

// --- Skill Radar Engine ---

model UserSkillScore {
  userId String @id
  user   User   @relation(fields: [userId], references: [id])

  // Normalized Scores (0-100)
  coding          Float @default(0)
  quality         Float @default(0)
  bugDetection    Float @default(0)
  security        Float @default(0)
  collaboration   Float @default(0)
  architecture    Float @default(0)
  consistency     Float @default(0)
  communityImpact Float @default(0)

  lastCalculatedAt DateTime @default(now())

  snapshots RadarSnapshot[]
}

model SkillRawMetrics {
  userId String @id
  user   User   @relation(fields: [userId], references: [id])

  // Coding
  commitsPushed   Int @default(0)
  prCreated       Int @default(0)
  prMerged        Int @default(0)
  linesChanged    Int @default(0)
  mergeSuccessRate Float @default(0.0)

  // Quality
  prApprovalRate   Float @default(0.0)
  rejectionRate    Float @default(0.0)
  revertRate       Float @default(0.0)
  testCoverageGain Float @default(0.0)

  // Bug Detection
  bugsReported    Int   @default(0)
  bugsFixed       Int   @default(0)
  bugAccuracy     Float @default(0.0)
  
  // Security
  securityIssuesReported Int @default(0)
  vulnerabilitiesFixed   Int @default(0)
  
  // Collaboration
  commentsPosted       Int @default(0)
  prReviewsGiven       Int @default(0)
  crossRepoContribs    Int @default(0)
  
  // Architecture
  reposCreated         Int @default(0)
  workspacesCreated    Int @default(0)
  largeFeaturesMerged  Int @default(0)
  designDocsCreated    Int @default(0)
  
  // Consistency
  currentStreak        Int @default(0)
  weeklyActiveDays     Int @default(0)
  
  // Community
  starsReceived        Int @default(0)
  forks                Int @default(0)
  followers            Int @default(0)
  karma                Int @default(0)

  updatedAt DateTime @updatedAt
}

model ActivityEvent {
  id        String   @id @default(uuid())
  userId    String
  type      String   // e.g., 'COMMIT_PUSH', 'PR_MERGE', 'BUG_FIX'
  metadata  Json?
  timestamp DateTime @default(now())
  
  // Optional relations for context
  repoId      String?
  workspaceId String?
  
  @@index([userId, type])
  @@index([timestamp])
}

model RadarSnapshot {
  id        String   @id @default(uuid())
  userId    String
  userScore UserSkillScore @relation(fields: [userId], references: [userId])
  
  scores    Json     // Stores the state of 8 axes at this point in time
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}
